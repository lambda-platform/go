"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[5896],{6550:(e,t,r)=>{r.r(t),r.d(t,{default:()=>o});const a={props:["model","rule","label","meta","do_render","editMode","tbl"],components:{},data:function(){return{isShow:!1,map:null,parcelLayer:null,currentLayer:null,vector:null,source:null,isLoading:!1,isLoadingLayer:!1,q:"",selectedLayer:null,layers:{otm:new ol.source.TileImage({url:"https://{a-c}.tile.opentopomap.org/{z}/{x}/{y}.png"}),osm:new ol.source.TileImage({url:"https://{a-c}.tile.openstreetmap.org/{z}/{x}/{y}.png"}),osmBW:new ol.source.TileImage({url:"https://tiles.wmflabs.org/bw-mapnik/{z}/{x}/{y}.png"}),osmCycle:new ol.source.TileImage({url:"https://tile.thunderforest.com/cycle/{z}/{x}/{y}.png"}),googleLayerRoadNames:new ol.source.TileImage({url:"https://mt1.google.com/vt/lyrs=h&x={x}&y={y}&z={z}"}),googleLayerRoadmap:new ol.source.TileImage({url:"https://mt1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}"}),googleLayerSatellite:new ol.source.TileImage({url:"https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}"}),esriLayerStreet:new ol.source.TileImage({url:"https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}"}),esriLayerTopo:new ol.source.TileImage({url:"https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}"}),cartoPositron:new ol.source.TileImage({url:"https://cartodb-basemaps-a.global.ssl.fastly.net/light_all/{z}/{x}/{y}.png"}),stamenTerrain:new ol.source.TileImage({url:"https://a.tile.stamen.com/terrain/{z}/{x}/{y}.png"}),alagacSpecial:new ol.source.TileImage({url:"https://geoportal.nsdi.gov.mn/alagac/rest/services/ALAGAC/11THG/MapServer/tile/{z}/{y}/{x}"}),alagacForest:new ol.source.TileImage({url:"https://geoportal.nsdi.gov.mn/alagac/rest/services/ALAGAC/CTM_map/MapServer/tile/{z}/{y}/{x}"}),nsdi:new ol.source.TileImage({url:"https://gisserver01.nsdi.gov.mn/gzbgzzg/rest/services/EngineerHM/Ulaanbaatar_Gazar_Hudlul_Bichil_Mujlal_Hursnii_Orgil_Hurdatgal_UTM48N/MapServer/export?bbox=606139.8364730093,5264976.112310054,765882.3714873542,5333060.391939491"})},filterFrm:{aimag_id:null,sum_id:null,bag_id:null},aimag:[],soum:[],bag:[],selectedAu:null,auCode:null}},created:function(){this.getAimag()},computed:{geoVal:function(){return this.model.form[this.model.component]}},watch:{do_render:function(e,t){var r=this;e?(this.isShow=!0,this.$nextTick((function(){r.initMap()}))):(this.isShow=!1,this.destroy())},geoVal:function(e,t){e&&null===t&&this.getGisData(1)}},methods:{initMap:function(){var e=this;this.source=new ol.source.Vector,this.vector=new ol.layer.Vector({source:this.source,style:new ol.style.Style({fill:new ol.style.Fill({color:"rgba(255, 255, 255, 0.2)"}),stroke:new ol.style.Stroke({color:"#ffcc33",width:2}),image:new ol.style.Circle({radius:7,fill:new ol.style.Fill({color:"#ffcc33"})})})}),this.currentLayer=new ol.layer.Tile({source:new ol.source.TileImage({url:"https://mt1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}",crossOrigin:"Anonymous"})}),this.map=new ol.Map({target:"qgis",layers:[this.currentLayer,this.vector],view:new ol.View({center:ol.proj.fromLonLat([106.831832,47.8916288]),zoom:12}),controls:ol.control.defaults().extend([new ol.control.FullScreen])}),this.drawLayer(),this.map.on("click",(function(t){var r=ol.proj.transform(t.coordinate,"EPSG:3857","EPSG:4326"),a=parseFloat(r[1]).toFixed(6),o=parseFloat(r[0]).toFixed(6);if(e.map.getView().setCenter(ol.proj.fromLonLat([parseFloat(o),parseFloat(a)])),e.map.getView().setZoom(18),null!=e.parcelLayer){var s=e.map.getView(),i=s.getResolution(),l=e.parcelLayer.getSource().getGetFeatureInfoUrl(t.coordinate,i,s.getProjection(),{INFO_FORMAT:"application/json",FEATURE_COUNT:50});l&&(e.isLoadingLayer=!0,fetch(l).then((function(e){return e.json()})).then((function(t){e.isLoadingLayer=!1,null!=t&&t.features.length>0&&t.features.forEach((function(t){t.properties&&(e.setFormField(t.properties),e.model.form[e.model.component]=t.properties[e.meta.qgisOptions.cAttr],e.geoVal=t.properties[e.meta.qgisOptions.cAttr],Object.prototype.hasOwnProperty.call(t.properties,"gid")?e.getGisData(0):e.$Message.error("Gid тохируулаагүй байна!"))}))})).catch((function(t){e.isLoadingLayer=!1})))}})),this.map.removeLayer(this.selectedLayer),this.map.removeLayer(this.markerLayer)},switchLayer:function(e){switch(e){case"otm":this.currentLayer.setSource(this.layers.otm);break;case"googleRoad":this.currentLayer.setSource(this.layers.googleLayerRoadmap);break;case"googleSatellite":this.currentLayer.setSource(this.layers.googleLayerSatellite);break;case"esriTopo":this.currentLayer.setSource(this.layers.esriLayerTopo);break;case"esriStreet":this.currentLayer.setSource(this.layers.esriLayerStreet);break;case"cartoPositron":this.currentLayer.setSource(this.layers.cartoPositron);break;case"stamenTerrain":this.currentLayer.setSource(this.layers.stamenTerrain);break;case"osm":this.currentLayer.setSource(this.layers.osm);break;case"osmBW":this.currentLayer.setSource(this.layers.osmBW);break;case"osmCycle":this.currentLayer.setSource(this.layers.osmCycle);break;case"alagacSpecial":this.currentLayer.setSource(this.layers.alagacSpecial);break;case"alagacForest":this.currentLayer.setSource(this.layers.alagacForest);break;case"nsdi":this.currentLayer.setSource(this.layers.nsdi)}},setFormField:function(e){var t=this;this.meta.qgisOptions.attrList.forEach((function(r){t.model.form[r.label]=e[r.value]}))},drawLayer:function(){this.map.removeLayer(this.parcelLayer),this.isLoadingLayer=!0,this.parcelLayer=new ol.layer.Tile({name:"wms",source:new ol.source.TileWMS({ratio:1,url:this.meta.qgisOptions.service,params:{FORMAT:"image/png",VERSION:"1.1.1",tiled:!0,STYLES:"",LAYERS:this.meta.qgisOptions.link,exceptions:"application/vnd.ogc.se_inimage",viewparams:"code:"+this.auCode,tilesOrigin:"619573.6875,5296553.5"}})}),this.map.addLayer(this.parcelLayer),this.isLoadingLayer=!1},getGisData:function(e){var t=this;this.isLoading=!0,axios.get("/urban/gis/".concat(this.meta.qgisOptions.cTable,"/").concat(this.meta.qgisOptions.cShapeField,"/").concat(this.meta.qgisOptions.cAttr,"/").concat(this.geoVal,"?tbl=").concat(this.tbl,"&edit=").concat(e)).then((function(e){var r=e.data;if(r.status){if(t.map.removeLayer(t.selectedLayer),r.point){var a=JSON.parse(r.geo_shape);t.drawSelectedPoint(a.coordinates)}else t.drawSelected(r.shape);var o=JSON.parse(r.center);t.map.getView().setCenter(ol.proj.fromLonLat(o.coordinates)),t.map.getView().setZoom(16)}else t.$Message.error(r.msg);t.isLoading=!1})).catch((function(){t.isLoading=!1}))},drawSelectedPoint:function(e){console.log("I am point",e),this.map.removeLayer(this.markerLayer);var t=new ol.geom.Point(ol.proj.transform(e,"EPSG:4326","EPSG:3857")),r=new ol.Feature({geometry:t}),a=new ol.style.Icon({src:"/images/markers/default.png"});r.setStyle(new ol.style.Style({image:a}));var o=new ol.source.Vector({features:[r]});this.markerLayer=new ol.layer.Vector({title:"Selected Point",visible:!0,source:o}),this.map.addLayer(this.markerLayer)},drawSelected:function(e){this.map.removeLayer(this.selectedLayer);var t=(new ol.format.WKT).readFeature(e);t.getGeometry().transform("EPSG:4326","EPSG:3857");var r=new ol.style.Style({fill:new ol.style.Fill({color:"rgba(255,0,0, .5)"}),stroke:new ol.style.Stroke({color:"rgba(255,0,0, 1)",width:4})});this.selectedLayer=new ol.layer.Vector({source:new ol.source.Vector({features:[t]}),style:r}),this.map.addLayer(this.selectedLayer)},destroy:function(){this.filterFrm={aimag_id:null,sum_id:null,bag_id:null}},getAimag:function(){var e=this;axios.get("/api/aimag").then((function(t){e.aimag=t.data,e.editMode&&e.getSum(e.filterFrm.aimag_id)}))},getSum:function(e){var t=this;if(console.log("a ID: ",e),void 0!==e){console.log("I am here"),this.soum=[],this.filterFrm.aimag_id=e,this.filterFrm.sum_id=null,axios.get("/api/sum/"+e).then((function(e){t.soum=e.data}));var r=this.aimag.find((function(t){return t.code==e})),a=JSON.parse(r.center);this.map.getView().setCenter(ol.proj.fromLonLat([parseFloat(a.coordinates[0]),parseFloat(a.coordinates[1])])),this.map.getView().setZoom(8),this.drawPolygon(r.shape),this.auCode=e,this.drawLayer()}},getBag:function(e){var t=this;this.filterFrm.sum_id=e,this.bag=[],this.filterFrm.bag_id=null,axios.get("/api/baghoroo/"+e).then((function(e){t.bag=e.data}));var r=this.soum.find((function(t){return t.code==e})),a=JSON.parse(r.center);this.map.getView().setCenter(ol.proj.fromLonLat([parseFloat(a.coordinates[0]),parseFloat(a.coordinates[1])])),this.map.getView().setZoom(9),this.drawPolygon(r.shape),this.auCode=e,this.drawLayer()},zoomToBag:function(e){this.filterFrm.bag_id=e;var t=this.bag.find((function(t){return t.code==e})),r=JSON.parse(t.center);this.map.getView().setCenter(ol.proj.fromLonLat([parseFloat(r.coordinates[0]),parseFloat(r.coordinates[1])])),this.map.getView().setZoom(14),this.drawPolygon(t.shape),this.auCode=e,this.drawLayer()},drawPolygon:function(e){null!=this.selectedAu&&this.map.removeLayer(this.selectedAu),e=JSON.parse(e);var t=new ol.source.Vector({features:(new ol.format.GeoJSON).readFeatures(e,{featureProjection:"EPSG:3857"})});this.selectedAu=new ol.layer.Vector({source:t,style:new ol.style.Style({stroke:new ol.style.Stroke({color:"rgba(0, 0, 0, 0.3)",lineDash:[4],width:2}),fill:new ol.style.Fill({color:"rgba(0,0,0, 0.1)"})})}),this.map.addLayer(this.selectedAu)}}};const o=(0,r(51900).Z)(a,(function(){var e=this,t=e._self._c;return t("FormItem",{attrs:{label:e.label,prop:e.rule}},[e.isShow?t("div",{staticClass:"qgis-map"},[e.isLoading?t("Spin",{attrs:{fix:""}}):e._e(),e._v(" "),e.isLoadingLayer?t("Spin",{attrs:{fix:""}}):e._e(),e._v(" "),t("div",{staticStyle:{height:"350px","border-radius":"10px"},attrs:{id:"qgis"}}),e._v(" "),t("div",{staticClass:"map-layer-switcher"},[t("a",{attrs:{href:"javascript:void(0)"},on:{click:function(t){return e.switchLayer("googleRoad")}}},[t("img",{attrs:{src:"/images/maps/google-road.jpg",alt:""}}),e._v(" "),t("span",[e._v("Google road")])]),e._v(" "),t("a",{attrs:{href:"javascript:void(0)"},on:{click:function(t){return e.switchLayer("googleSatellite")}}},[t("img",{attrs:{src:"/images/maps/google-satellite.jpg",alt:""}}),e._v(" "),t("span",[e._v("Google satellite")])]),e._v(" "),t("a",{attrs:{href:"javascript:void(0)"},on:{click:function(t){return e.switchLayer("osm")}}},[t("img",{attrs:{src:"/images/maps/openstreet.jpg",alt:""}}),e._v(" "),t("span",[e._v("Open Street Map")])])]),e._v(" "),t("div",{staticClass:"map-filter"},[t("Select",{attrs:{placeholder:"Аймаг/Хот",size:"small"},on:{"on-change":e.getSum},model:{value:e.filterFrm.aimag_id,callback:function(t){e.$set(e.filterFrm,"aimag_id",t)},expression:"filterFrm.aimag_id"}},e._l(e.aimag,(function(e){return t("Option",{key:e.code,attrs:{label:e.name,value:e.code}})})),1),e._v(" "),t("Select",{attrs:{placeholder:"Сум/Дүүрэг",size:"small"},on:{"on-change":e.getBag},model:{value:e.filterFrm.sum_id,callback:function(t){e.$set(e.filterFrm,"sum_id",t)},expression:"filterFrm.sum_id"}},e._l(e.soum,(function(e){return t("Option",{key:e.code,attrs:{label:e.name,value:e.code}})})),1),e._v(" "),t("Select",{attrs:{placeholder:"Баг/Хороо",size:"small"},on:{"on-change":e.zoomToBag},model:{value:e.filterFrm.bag_id,callback:function(t){e.$set(e.filterFrm,"bag_id",t)},expression:"filterFrm.bag_id"}},e._l(e.bag,(function(e){return t("Option",{key:e.code,attrs:{label:e.name,value:e.code}})})),1)],1)],1):e._e()])}),[],!1,null,null,null).exports}}]);