"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[8714],{35031:(e,t,o)=>{o.d(t,{A:()=>s});const s={data:()=>({preSource:[],modal_grid_show:!1,user_condition:null,custom_condition:null,sourceGridParentBasedCondition:null}),mounted(){void 0!==this.form.sourceGridUserCondition&&null!==this.form.sourceGridUserCondition&&""!=this.form.sourceGridUserCondition&&(this.user_condition=JSON.parse(this.form.sourceGridUserCondition)),void 0!==this.form.sourceGridParentBasedCondition&&null!==this.form.sourceGridParentBasedCondition&&""!=this.form.sourceGridParentBasedCondition&&(this.sourceGridParentBasedCondition=JSON.parse(this.form.sourceGridParentBasedCondition))},methods:{showAddSourceModal(){if(this.sourceGridParentBasedCondition){this.custom_condition={};let e=!1;this.sourceGridParentBasedCondition.forEach((t=>{void 0!==this.model.form[t.parent_field]&&null!==this.model.form[t.parent_field]?this.custom_condition[t.grid_field]=this.model.form[t.parent_field]:(e=!0,this.$Notice.error({title:t.message}))})),e||this.showAddSourceModalReal()}else this.showAddSourceModalReal()},showAddSourceModalReal(){this.modal_grid_show=!0,this.$modal.show(`grid-modal-${this.form.sourceGridID}`)},closeSourceModal(){this.modal_grid_show=!1,this.$modal.hide(`grid-modal-${this.form.sourceGridID}`)},addFromPreSource(){this.preSource&&this.form.sourceGridTargetColumns&&this.preSource.forEach((e=>{this.createDataFromSource(e)})),this.closeSourceModal()},createDataFromSource(e){let t=_.cloneDeep(this.form),o={};t.schema.forEach((e=>{t.identity!=e.model&&null!=e.formType&&(!t.timestamp||"created_at"!=e.model&&e.model)})),this.form.sourceGridTargetColumns.forEach((t=>{Vue.set(o,t.selfColumn,e[t.sourceColumn])}));let s={form:t,model:o};if(null==this.model.form[this.model.component]&&(this.model.form[this.model.component]=[]),""!==this.form.sourceUniqueField&&void 0!==this.form.sourceUniqueField&&null!==this.form.sourceUniqueField){let e=this.model.form[this.model.component].findIndex((e=>e[this.form.sourceUniqueField]===o[this.form.sourceUniqueField]));if(-1!==e)return}this.model.form[this.model.component].push(o),this.listData.push(s),this.rowLength=this.model.form[this.model.component].length},onRowSelect(e){this.preSource=e},sourceGridUrl(){if(window.init.microserviceSettings){let e=window.init.microserviceSettings.findIndex((e=>e.project_id==this.form.sourceMicroserviceID));return e>=0?window.init.microserviceSettings[e].production_url:""}return""}}}},51523:(e,t,o)=>{o.r(t),o.d(t,{default:()=>a});var s=o(97270),i=o(13856);const r={props:["form","model","editMode","relations","formula","url"],mixins:[o(35031).A],components:{"grid-form":i.A,dataform:()=>o.e(4517).then(o.bind(o,51330))},mounted(){this.equationRenderer(),this.form.schema.forEach((e=>{e.disabled=!0}))},computed:{lang(){const e=["pleaseCompleteFirstLine"];return e.reduce(((t,o,s)=>(t[o]=this.$t("dataForm."+e[s]),t)),{})},subStyle(){return this.form.min_height?{minHeight:this.form.min_height+"px",background:"#f3f4f5"}:void 0},Lang(){const e=["add"];return e.reduce(((t,o,s)=>(t[o]=this.$t("dataForm."+e[s]),t)),{})}},watch:{listData:{handler:function(e,t){this.hasEq&&this.equationData.map((t=>{if(t.hasEquation){t.data=-1;let o=0;switch(t.equation){case"SUM":t.data=0,e.map((e=>{t.data+=Number(isNaN(parseInt(e.model[t.model],10))?0:e.model[t.model])}));break;case"COUNT":t.data=0,e.map((e=>{t.data+=Number(1)}));break;case"MIN":e.map((e=>{-1==t.data?t.data=e.model[t.model]:t.data=Math.min(t.data,e.model[t.model])}));break;case"MAX":t.data=0,e.map((e=>{t.data=Math.max(t.data,e.model[t.model])}));break;case"AVG":t.data=0,e.map((e=>{o++,t.data+=Number(e.model[t.model])})),t.data=Number(t.data/o)}}}))},deep:!0}},data:()=>({listData:[],equationData:[],currentSortDir:"asc",hasEq:!1,modal_show:!1,editIndex:-1}),methods:{showAddModal(){this.modal_show=!0},closeModal(){this.modal_show=!1,this.editIndex=-1},formReady(e,t){let o=t.findIndex((e=>e.model==this.form.parent));o>0&&(t[o].hidden=!0),this.editIndex>=0&&this.$nextTick((()=>{this.$refs.form.editModel(this.listData[this.editIndex].model[this.form.identity],{...this.listData[this.editIndex].model})}))},onError(){},onSuccess(e){if(this.editIndex>=0)Object.keys(e).forEach((t=>{this.listData[this.editIndex].form.identity!=t&&"created_at"!=t&&"updated_at"!=t&&Vue.set(this.listData[this.editIndex].model,t,e[t])}));else{let t=_.cloneDeep(this.form),o={};Object.keys(e).forEach((s=>{let i=t.schema.findIndex((e=>"key"==e.model));if(i>=0){if(t.identity==t.schema[i].model||null==t.schema[i].formType)return;if(t.timestamp&&("created_at"==t.schema[i].model||"updated_at"==t.schema[i].model))return}Vue.set(o,s,e[s])}));let s={form:t,model:o},i=this.model.form[this.model.component];null==i&&(i=[]),i.push(o),Vue.set(this.model.form,this.model.component,i),this.listData.push(s)}this.closeModal()},element:s.ND,checkAddable(){return new Promise(((e,t)=>{let o=this.listData[this.listData.length-1];if(o){let s=!1,i=o.model;for(let e in i)null!=typeof i[e]&&null!=i[e]&&""!=i[e]&&0!=i[e]&&(s=!0);s?e(!0):(alert(this.lang.pleaseCompleteFirstLine),t(!1))}else e(!0)}))},addSubForm(){let e=_.cloneDeep(this.form),t={};e.schema.forEach((o=>{e.identity!=o.model&&null!=o.formType&&(!e.timestamp||"created_at"!=o.model&&"updated_at"!=o.model)&&Vue.set(t,o.model,o.default)}));let o={form:e,model:t};null==this.model.form[this.model.component]&&(this.model.form[this.model.component]=[]),this.model.form[this.model.component].push(t),this.listData.push(o)},add(){this.form.addFromGrid&&this.form.sourceGridID?this.showAddSourceModal():this.addByFrom()},addByFrom(){this.closeSourceModal(),this.editIndex=-1,this.showAddModal()},fillData(){this.listData=[],setTimeout((()=>{this.model.form[this.model.component].forEach((e=>{let t={form:_.cloneDeep(this.form),model:e};this.listData.push(t)})),console.log("sun form fill",this.model.form[this.model.component])}),100)},equationRenderer(){this.equationData=[],this.form.schema.map((e=>{""==e.label||e.hidden||(e.hasEquation&&(this.hasEq=!0),this.equationData.push({hasEquation:e.hasEquation,equation:e.equations,prefix:e.prefix,model:e.model,preStaticWord:e.preStaticWord,data:0}))}))},edit(e){this.model.form[this.form.model][e],this.editIndex=e,this.showAddModal()},remove(e){this.model.form[this.form.model].splice(e,1),this.listData.splice(e,1)},reset(){this.model.form[this.form.model]=[],this.listData=[]},sort(e){let t=1;this.currentSortDir="asc"===this.currentSortDir?"desc":"asc",this.currentSort="desc"===this.currentSortDir?-1:1,this.currentSort=e.model,this.listData.sort(((e,o)=>("desc"===this.currentSortDir&&(t=-1),e.model[this.currentSort]<o.model[this.currentSort]?-1*t:e.model[this.currentSort]>o.model[this.currentSort]?1*t:0)))}}};const a=(0,o(14486).A)(r,(function(){var e=this,t=e._self._c;return t("div",{staticClass:"subform-grid sub-modal-form",style:e.subStyle},[e.form.min_height||e.form.disableCreate?e._e():t("div",{staticClass:"subform-header"},[e._v("\n        "+e._s(e.form.name)+"\n        "),t("Button",{staticClass:"sub-form-add-btn",attrs:{shape:"circle",type:"success",size:"small",icon:"md-add"},on:{click:e.add}})],1),e._v(" "),t("div",{staticClass:"sub-form-table-wrap"},[e.form.min_height||this.listData.length>=1?t("table",{staticClass:"sub-form-grid",attrs:{border:"1"}},[t("thead",[t("tr",[e.form.showRowNumber?t("th",{staticClass:"row-number"},[e._v("ДД")]):e._e(),e._v(" "),e._l(e.form.schema,(function(o){return""==o.label||o.hidden?e._e():t("th",{key:o.index,on:{click:function(t){return e.sort(o)}}},[t("div",{staticClass:"th-title"},[e._v("\n                        "+e._s(o.label)+" "),t("i",{staticClass:"ti-exchange-vertical"})])])})),e._v(" "),t("th",{staticClass:"action"},[e._v("...")])],2)]),e._v(" "),t("tbody",e._l(e.listData,(function(o,s){return t("grid-form",{key:s,attrs:{f:o.form,model:o.model,editMode:e.editMode,relations:e.relations,formula:e.formula,schema:e.form.schema}},[t("template",{slot:"action"},[e.form.disableEdit?e._e():t("a",{staticClass:"sub-edit",attrs:{href:"javscript:void(0)"},on:{click:()=>e.edit(s)}},[t("Icon",{attrs:{type:"md-create"}})],1),e._v(" "),e.form.disableDelete?e._e():t("a",{attrs:{href:"javscript:void(0)"},on:{click:()=>e.remove(s)}},[t("Icon",{attrs:{type:"ios-trash"}})],1)]),e._v(" "),e.form.showRowNumber?t("template",{slot:"rowNumber"},[t("span",[e._v(e._s(s+1))])]):e._e()],2)})),1),e._v(" "),e.hasEq?t("tfoot",[t("tr",[e._l(e.equationData,(function(o,s){return t("td",{key:s},[null!=o.preStaticWord&&""!=o.preStaticWord?t("span",[e._v(e._s(o.preStaticWord)+" ")]):e._e(),e._v(" "),o.hasEquation?t("span",[e._v(e._s(o.data.toLocaleString()))]):e._e(),e._v(" "),null!=o.prefix&&""!=o.prefix?t("span",[e._v(" "+e._s(o.prefix))]):e._e()])})),e._v(" "),t("td")],2)]):e._e()]):e._e()]),e._v(" "),e.form.min_height?t("a",{staticClass:"sub-grid-add",attrs:{href:"javascript:void(0)"},on:{click:e.add}},[t("Icon",{attrs:{type:"plus"}}),e._v("\n        "+e._s(e.lang.save)+"\n    ")],1):e._e(),e._v(" "),t("Modal",{staticClass:"dataform-model-form",attrs:{"min-width":200,"min-height":100,draggable:!0,"footer-hide":!0,title:e.form.name,mask:!0,width:"80vw"},model:{value:e.modal_show,callback:function(t){e.modal_show=t},expression:"modal_show"}},[t("section",{staticClass:"form-modal"},[t("div",{staticClass:"form-body"},[e.modal_show?t("dataform",{ref:"form",attrs:{schemaID:e.form.formId,do_render:e.modal_show,editMode:e.editIndex>=0,isSubForm:!0,onSuccess:e.onSuccess,url:e.url,onReady:e.formReady,onError:e.onError}}):e._e()],1)])]),e._v(" "),t("paper-modal",{staticClass:"form-modal",attrs:{name:`grid-modal-${e.form.sourceGridID}`,"min-width":200,"min-height":100,"pivot-y":.5,adaptive:!0,reset:!0,draggable:!0,resizable:!0,draggable:".form-tool",width:"85%",height:"80%"}},[t("section",{staticClass:"form-modal source-grid"},[t("div",{staticClass:"form-tool"},[t("h4",[e._v(e._s(e.form.sourceGridModalTitle))]),e._v(" "),t("div",{staticClass:"form-tool-actions"},[t("a",{attrs:{href:"javascript:void(0)"},on:{click:e.closeSourceModal}},[t("i",{staticClass:"ti-close"})])])]),e._v(" "),e.modal_grid_show?t("div",{staticClass:"form-body"},[e.form.sourceGridTitle&&e.form.sourceGridDescription?t("div",{staticClass:"source-grid-description"},[t("h3",[e._v(e._s(e.form.sourceGridTitle))]),e._v(" "),t("p",{domProps:{innerHTML:e._s(e.form.sourceGridDescription)}})]):e._e(),e._v(" "),t("datagrid",{attrs:{schemaID:e.form.sourceGridID,url:e.sourceGridUrl(),onRowSelect:e.onRowSelect,user_condition:e.user_condition,paginate:50,hasSelection:!0,permissions:{c:!1,r:!0,u:!1,d:!1}}}),e._v(" "),t("div",{staticClass:"add-from-pre-source"},[t("Button",{staticClass:"sub-form-add-btn",attrs:{shape:"circle",type:"primary",size:"small",disabled:e.preSource.length>=1,icon:"md-add"},on:{click:e.addByFrom}},[e._v("Шинээр бүртгэх\n                    ")]),e._v(" "),t("Button",{staticClass:"sub-form-add-btn",attrs:{shape:"circle",type:"success",size:"small",disabled:0==e.preSource.length,icon:"md-add"},on:{click:e.addFromPreSource}},[e._v("Сонгох\n                    ")])],1)],1):e._e()])])],1)}),[],!1,null,null,null).exports},13856:(e,t,o)=>{o.d(t,{A:()=>d});var s=o(97270),i=(o(65862),o(54991)),r=o(87161);const a={props:["f","model","editMode","relations","formula","schema"],created(){this.f.data={},this.f.schema.forEach((e=>{this.f.identity!=e.model&&null!=e.formType&&(!this.f.timestamp||"created_at"!=e.model&&"updated_at"!=e.model)&&(this.editMode?this.setModel(e.model,this.model[e.model],e.formType):this.setModel(e.model,e.default,e.formType),this.$watch("model."+e.model,{handler:(t,o)=>{this.afterChange(e.model,t,o)},deep:!0}))}))},methods:{isShowAble(e){if(this.schema){let t=this.schema.findIndex((t=>t.model==e));return t>=0&&!this.schema[t].hidden}return!0},element:s.ND,setModel(e,t,o){switch(o){case"Switch":let o=!1;"true"!=t&&1!=t||(o=!0),this.model[e]=s,this.f.data[e]=s;break;case"Checkbox":let s=0;"true"!=t&&1!=t||(s=1),this.model[e]=s,this.f.data[e]=s;break;default:this.f.data[e]=t}},setMeta:e=>(delete e.table,delete e.rules,delete e.label,delete e.span,delete e.default,e),getSchemaIndex(e){return this.f.schema.findIndex((t=>t.model==e))},afterChange(e,t,o){(0,i.QL)(e,t,this.model,this.f.schema,this.$refs,this.$Notice),(0,i.EY)(this.formula,e,this.model,this.f.schema,this.f.rule,this.f.model)},getSchemaRelationByModel(e){let t=this.f.schema.findIndex((t=>t.model==e));return t>=0?(0,r.Jx)(this.f.schema[t],this.relations):null},getRelation(e){return(0,r.Jx)(e,this.relations)}}};const d=(0,o(14486).A)(a,(function(){var e=this,t=e._self._c;return t("tr",[e.f.showRowNumber?t("td",{staticClass:"row-number"},[e._t("rowNumber")],2):e._e(),e._v(" "),e._l(e.f.schema,(function(o){return void 0!==o.formType&&null!==o.formType&&o.model&&e.isShowAble(o.model)&&o.model!=e.f.identity&&o.model!=e.f.parent&&"updated_at"!=o.model&&"created_at"!=o.model&&!o.hidden?t("td",{key:o.index},[e.model?t(e.element(o.formType),{tag:"component",attrs:{model:{form:e.model,component:o.model},size:"small",label:o.label?o.label:`[${o.model}]`,meta:e.setMeta(o),getSchemaRelationByModel:e.getSchemaRelationByModel,relation_data:e.getRelation(o)}}):e._e()],1):e._e()})),e._v(" "),t("td",{staticClass:"action"},[e._t("action")],2)],2)}),[],!1,null,null,null).exports}}]);