import{e as C}from"./DrY4oXhV.js";import{G as F,s as G}from"./DWFOM7vZ.js";import{_ as x}from"./BGcy_aHF.js";import{aZ as N,D as g,E as n,F as a,L as m,H as u,O as k,N as b,I as f,G as d,M as y,U as D,J as S,aG as T,a2 as R}from"./DXHvmmg6.js";import"./2tDPZFmp.js";import"./BPY4Idc9.js";import"./B4FiMg9Z.js";import"./CByKS65z.js";import"./BYTvHWBW.js";import"./CYxtEuKL.js";const L={props:["form","model","editMode","relations","formula","url","viewMode","validateWithSubForm"],mixins:[G],components:{"grid-form":F,"a-modal":N},mounted(){this.equationRenderer(),this.form.schema.forEach(o=>{o.disabled=!0})},computed:{lang(){const o=["pleaseCompleteFirstLine"];return o.reduce((t,e,r)=>(t[e]=this.$t("dataForm."+o[r]),t),{})},subStyle(){if(this.form.min_height)return{minHeight:this.form.min_height+"px",background:"#f3f4f5"}},Lang(){const o=["add"];return o.reduce((t,e,r)=>(t[e]=this.$t("dataForm."+o[r]),t),{})}},watch:{listData:{handler:function(o,t){this.hasEq&&this.equationData.map(e=>{if(e.hasEquation){e.data=-1;let r=0;switch(e.equation){case"SUM":{e.data=0,o.map(s=>{e.data+=Number(isNaN(parseInt(s.model[e.model],10))?0:s.model[e.model])});break}case"COUNT":{e.data=0,o.map(s=>{e.data+=1});break}case"MIN":{o.map(s=>{e.data==-1?e.data=s.model[e.model]:e.data=Math.min(e.data,s.model[e.model])});break}case"MAX":{e.data=0,o.map(s=>{e.data=Math.max(e.data,s.model[e.model])});break}case"AVG":{e.data=0,o.map(s=>{r++,e.data+=Number(s.model[e.model])}),e.data=Number(e.data/r);break}}}})},deep:!0}},data(){return{listData:[],equationData:[],currentSortDir:"asc",hasEq:!1,modal_show:!1,filled:!1,editIndex:-1}},methods:{showAddModal(){this.modal_show=!0},closeModal(){this.modal_show=!1,this.editIndex=-1},formReady(o,t){let e=t.findIndex(r=>r.model===this.form.parent);e>0&&(t[e].hidden=!0),this.editIndex>=0&&this.$nextTick(()=>{this.viewMode&&(this.$refs.form.viewMode=!0),this.$refs.form.editModel(this.listData[this.editIndex].model[this.form.identity],{...this.listData[this.editIndex].model})})},onError(){},onSuccess(o){if(this.editIndex>=0)Object.keys(o).forEach(t=>{this.listData[this.editIndex].form.identity!=t&&(t=="created_at"||t=="updated_at"||(this.listData[this.editIndex].model[t]=o[t]))});else{let t=_.cloneDeep(this.form),e={};Object.keys(o).forEach(l=>{let c=t.schema.findIndex(v=>v.model=="key");c>=0&&(t.identity==t.schema[c].model||t.schema[c].formType==null||t.timestamp&&(t.schema[c].model=="created_at"||t.schema[c].model=="updated_at"))||(e[l]=o[l])});let r={form:t,model:e},s=this.model.form[this.model.component];s==null&&(s=[]),s.push(e),this.model.form[this.model.component]=s,this.listData.push(r)}this.editMode&&this.validateWithSubForm(!0),this.closeModal()},element:C,checkAddable(){return new Promise((o,t)=>{let e=this.listData[this.listData.length-1];if(e){let r=!1,s=e.model;for(let l in s)typeof s[l]!=null&&s[l]!=null&&s[l]!=""&&s[l]!=!1&&(r=!0);r?o(!0):(alert(this.lang.pleaseCompleteFirstLine),t(!1))}else o(!0)})},addSubForm(){let o=_.cloneDeep(this.form),t={};o.schema.forEach(r=>{o.identity==r.model||r.formType==null||o.timestamp&&(r.model=="created_at"||r.model=="updated_at")||(t[r.model]=r.default)});let e={form:o,model:t};this.model.form[this.model.component]==null&&(this.model.form[this.model.component]=[]),this.model.form[this.model.component].push(t),this.listData.push(e)},add(){this.form.addFromGrid&&this.form.sourceGridID?this.showAddSourceModal():this.addByFrom()},addByFrom(){this.closeSourceModal(),this.editIndex=-1,this.showAddModal()},fillData(o){this.$nextTick(()=>{let t=[];o.forEach(e=>{t.push({form:_.cloneDeep(this.form),model:e})}),this.listData=t})},equationRenderer(){this.equationData=[],this.form.schema.map(o=>{o.label!=""&&!o.hidden&&(o.hasEquation&&(this.hasEq=!0),this.equationData.push({hasEquation:o.hasEquation,equation:o.equations,prefix:o.prefix,model:o.model,preStaticWord:o.preStaticWord,data:0}))})},edit(o){this.model.form[this.form.model][o],this.editIndex=o,this.showAddModal()},remove(o){this.model.form[this.form.model].splice(o,1),this.listData.splice(o,1)},reset(){this.model.form[this.form.model]=[],this.listData=[]},sort(o){let t=1;this.currentSortDir=this.currentSortDir==="asc"?"desc":"asc",this.currentSort=this.currentSortDir==="desc"?-1:1,this.currentSort=o.model,this.listData.sort((e,r)=>(this.currentSortDir==="desc"&&(t=-1),e.model[this.currentSort]<r.model[this.currentSort]?-1*t:e.model[this.currentSort]>r.model[this.currentSort]?1*t:0))}}},A={key:0,class:"subform-header"},B={class:"svg-icon"},V={key:1,class:"sub-form-grid",border:"1"},W={key:0,class:"row-number"},j=["onClick"],U={class:"th-title"},z={key:1,class:"action"},H={key:2,class:"action-for-view"},O=["onClick"],P={class:"svg-icon"},J=["onClick"],X={class:"svg-icon"},Z=["onClick"],Q={class:"svg-icon"},Y={key:0},q={key:0},K={key:1},$={key:2},ee={class:"svg-icon"},te={class:"form-modal"},oe={class:"form-body"},se={class:"form-modal source-grid"},ie={class:"form-tool"},re={class:"form-tool-actions"},de={key:0,class:"form-body"},ae={key:0,class:"source-grid-description"},le=["innerHTML"],ne={class:"add-from-pre-source"};function me(o,t,e,r,s,l){const c=g("inline-svg"),v=g("a-button"),M=g("grid-form"),I=g("dataform"),p=g("a-modal"),E=g("datagrid");return a(),n("div",{class:"subform-grid sub-modal-form",style:R(l.subStyle)},[!e.form.min_height&&!e.form.disableCreate&&!e.viewMode?(a(),n("div",A,[k(b(e.form.name)+" ",1),u(v,{shape:"circle",type:"success",size:"small",onClick:l.add,class:"sub-form-add-btn"},{icon:f(()=>[d("span",B,[u(c,{src:"/assets/icons/duotune/general/gen041.svg"})])]),_:1},8,["onClick"])])):m("",!0),e.form.min_height||this.listData.length>=1?(a(),n("table",V,[d("thead",null,[d("tr",null,[e.form.showRowNumber?(a(),n("th",W,"ДД")):m("",!0),(a(!0),n(y,null,D(e.form.schema.filter(i=>i.label!==""&&!i.hidden),i=>(a(),n("th",{onClick:h=>l.sort(i),key:i.index},[d("div",U,[k(b(i.label)+" ",1),t[4]||(t[4]=d("i",{class:"ti-exchange-vertical"},null,-1))])],8,j))),128)),!e.form.disableEdit||!e.form.disableDelete?(a(),n("th",z,"...")):m("",!0),e.viewMode?(a(),n("th",H,"...")):m("",!0)])]),d("tbody",null,[(a(!0),n(y,null,D(s.listData,(i,h)=>(a(),S(M,{key:h,rowIndex:h,f:i.form,model:i.model,editMode:e.editMode,viewMode:e.viewMode,relations:e.relations,formula:e.formula,schema:e.form.schema,onEdit:()=>l.edit(h)},T({action:f(()=>[e.form.disableEdit?m("",!0):(a(),n("a",{key:0,href:"javascript:void(0);",class:"btn btn-icon sub-edit",onClick:w=>l.edit(h)},[d("span",P,[u(c,{src:"/assets/icons/duotone/Design/Edit.svg"})])],8,O)),e.form.disableDelete?m("",!0):(a(),n("a",{key:1,href:"javascript:void(0);",class:"btn btn-icon",onClick:w=>l.remove(h)},[d("span",X,[u(c,{src:"/assets/icons/duotone/General/Trash.svg"})])],8,J))]),view:f(()=>[e.viewMode?(a(),n("a",{key:0,href:"javascript:void(0);",class:"btn btn-icon sub-edit",onClick:w=>l.edit(h)},[d("span",Q,[u(c,{src:"/assets/icons/duotone/General/Visible.svg"})])],8,Z)):m("",!0)]),_:2},[e.form.showRowNumber?{name:"rowNumber",fn:f(()=>[d("span",null,b(h+1),1)]),key:"0"}:void 0]),1032,["rowIndex","f","model","editMode","viewMode","relations","formula","schema","onEdit"]))),128))]),s.hasEq?(a(),n("tfoot",Y,[d("tr",null,[(a(!0),n(y,null,D(s.equationData,(i,h)=>(a(),n("td",{key:h},[i.preStaticWord!=null&&i.preStaticWord!=""?(a(),n("span",q,b(i.preStaticWord),1)):m("",!0),i.hasEquation?(a(),n("span",K,b(i.data.toLocaleString()),1)):m("",!0),i.prefix!=null&&i.prefix!=""?(a(),n("span",$,b(i.prefix),1)):m("",!0)]))),128)),t[5]||(t[5]=d("td",null,null,-1))])])):m("",!0)])):m("",!0),e.form.min_height?(a(),n("a",{key:2,class:"sub-grid-add",href:"javascript:void(0)",onClick:t[0]||(t[0]=(...i)=>l.add&&l.add(...i))},[d("span",ee,[u(c,{src:"/assets/icons/duotune/general/gen041.svg"})]),k(" "+b(l.lang.save),1)])):m("",!0),u(p,{"min-width":200,"min-height":100,draggable:!0,"footer-hide":!0,title:e.form.name,width:"85%",height:"85%",open:s.modal_show,"onUpdate:open":t[1]||(t[1]=i=>s.modal_show=i)},{footer:f(()=>t[6]||(t[6]=[])),default:f(()=>[d("section",te,[d("div",oe,[s.modal_show?(a(),S(I,{key:0,ref:"form",schemaID:e.form.formId,do_render:s.modal_show,editMode:s.editIndex>=0,isSubForm:!0,onSuccess:l.onSuccess,url:e.url,onReady:l.formReady,onError:l.onError},null,8,["schemaID","do_render","editMode","onSuccess","url","onReady","onError"])):m("",!0)])])]),_:1},8,["title","open"]),u(p,{name:`grid-modal-${e.form.sourceGridID}`,open:o.modal_grid_show,"onUpdate:open":t[3]||(t[3]=i=>o.modal_grid_show=i),class:"form-modal","min-width":200,"min-height":100,"pivot-y":.5,adaptive:!0,reset:!0,draggable:!0,resizable:!0,width:"85%",height:"50%"},{footer:f(()=>t[10]||(t[10]=[])),default:f(()=>[d("section",se,[d("div",ie,[d("h4",null,b(e.form.sourceGridModalTitle),1),d("div",re,[d("a",{href:"javascript:void(0)",onClick:t[2]||(t[2]=(...i)=>o.closeSourceModal&&o.closeSourceModal(...i))},t[7]||(t[7]=[d("i",{class:"ti-close"},null,-1)]))])]),o.modal_grid_show?(a(),n("div",de,[e.form.sourceGridTitle&&e.form.sourceGridDescription?(a(),n("div",ae,[d("h3",null,b(e.form.sourceGridTitle),1),d("p",{innerHTML:e.form.sourceGridDescription},null,8,le)])):m("",!0),u(E,{schemaID:e.form.sourceGridID,url:o.sourceGridUrl(),onRowSelect:o.onRowSelect,user_condition:o.user_condition,paginate:50,hasSelection:!0,permissions:{c:!1,r:!0,u:!1,d:!1}},null,8,["schemaID","url","onRowSelect","user_condition"]),d("div",ne,[u(v,{shape:"circle",type:"primary",size:"small",onClick:l.addByFrom,disabled:o.preSource.length>=1,icon:"md-add",class:"sub-form-add-btn"},{default:f(()=>t[8]||(t[8]=[k("Шинээр бүртгэх")])),_:1,__:[8]},8,["onClick","disabled"]),u(v,{shape:"circle",type:"success",size:"small",onClick:o.addFromPreSource,disabled:o.preSource.length==0,icon:"md-add",class:"sub-form-add-btn"},{default:f(()=>t[9]||(t[9]=[k("Сонгох")])),_:1,__:[9]},8,["onClick","disabled"])])])):m("",!0)])]),_:1},8,["name","open"])],4)}const De=x(L,[["render",me]]);export{De as default};
